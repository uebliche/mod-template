name: Test All Minecraft Versions

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      - name: Build loader/version matrix
        id: set-matrix
        run: |
          export MIN_VERSION=$(grep '^buildFromVersion=' gradle.properties | cut -d'=' -f2)
          MATRIX=$(python3 <<'PY'
          import json, os, pathlib, urllib.request

          min_version = os.environ["MIN_VERSION"]

          def parse_version(ver: str):
              parts = [int(part) for part in ver.split(".")]
              while len(parts) < 3:
                  parts.append(0)
              return parts

          def version_at_least(ver: str, minimum: str):
              return parse_version(ver) >= parse_version(minimum)

          data = json.loads(pathlib.Path("versions.matrix.json").read_text())
          matrix = []

          # Fabric entries: derive from fabric list or fallback to explicit matrix file
          fabric_versions = []
          if data.get("fabric"):
              for entry in data["fabric"]:
                  if isinstance(entry, str) and version_at_least(entry, min_version):
                      fabric_versions.append(entry)
          else:
              with urllib.request.urlopen("https://meta.fabricmc.net/v2/versions/game") as resp:
                  versions = json.load(resp)
              stable = sorted({entry["version"] for entry in versions if entry.get("stable")}, key=parse_version)
              fabric_versions = [ver for ver in stable if version_at_least(ver, min_version)]

          for mc in fabric_versions:
              matrix.append({"loader": "fabric", "mcVersion": mc, "args": []})

          # Forge entries
          for entry in data.get("forge", []):
              if isinstance(entry, str):
                  mc = entry
                  props = {}
              else:
                  mc = entry.get("mc") or entry.get("mcVersion")
                  props = entry.get("properties") or {}
              if not mc or not version_at_least(mc, min_version):
                  continue
              args = [f"-P{key}={value}" for key, value in props.items()]
              matrix.append({"loader": "forge", "mcVersion": mc, "args": args})

          print(json.dumps(matrix))
          PY
          )
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Resolved matrix: $MATRIX"

  test:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    name: Test ${{ matrix.loader }} ${{ matrix.mcVersion }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      - name: Test Build
        run: |
          ./gradlew :loader-${{ matrix.loader }}:build -PmcVersion=${{ matrix.mcVersion }} ${{ join(matrix.args, ' ') }}

  update-readme-badges:
    needs: [test, generate-matrix]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && always()
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install requests
        run: pip install requests
      - name: Update README badges
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MATRIX_JSON: ${{ needs.generate-matrix.outputs.matrix }}
        run: |
          VERSIONS=$(python3 <<'PY'
          import json, os
          matrix = json.loads(os.environ["MATRIX_JSON"])
          versions = sorted({entry["mcVersion"] for entry in matrix}, key=lambda v: [int(x) for x in v.split(".")])
          print(json.dumps(versions))
          PY
          )
          python3 update-readme-badges.py "$VERSIONS"
      - name: Commit and push README update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs(README): Update tested Minecraft version badges [skip ci]" || echo "No changes to commit"
          git push
