name: Publish
on:
  workflow_dispatch:
    inputs:
      version_type:
        type: choice
        description: Version Type
        options:
          - release
          - beta
          - alpha
      debug:
        type: boolean
        description: Debug build
        default: false
      version:
        type: string
        description: Version to build (only for single version builds)
        default: ''
      only_description:
        type: boolean
        description: Only update the description on Modrinth
        default: false

permissions:
  contents: write
  pull-requests: read

env:
  DEBUG: ${{ github.event.inputs.debug }}
  VERSION_TYPE: ${{ github.event.inputs.version_type }}

jobs:
  release:
    if: ${{ github.event.inputs.only_description != 'true' }}
    runs-on: ubuntu-latest
    outputs:
      TAG: ${{ steps.tag.outputs.TAG }}
      NOTES: ${{ steps.get_release_notes.outputs.notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create unique tag for release
        id: tag
        run: |
          DATE=$(date +'%Y.%m.%d')
          TAGS=$(git tag --list "${DATE}*")
          echo "Existing tags: $TAGS"
          
          if [ -z "$TAGS" ]; then
          VERSION="$DATE"
          else
          SUFFIXES=$(echo "$TAGS" | sed -n "s/^$DATE\([a-z]\).*$/\1/p")
          NEXT_SUFFIX="b"
          if [ -n "$SUFFIXES" ]; then
          LAST_SUFFIX=$(echo "$SUFFIXES" | sort | tail -n1)
          NEXT_SUFFIX=$(printf "\\$(printf '%03o' $(( $(printf '%d' "'$LAST_SUFFIX") + 1 )) )")
          fi
          VERSION="${DATE}${NEXT_SUFFIX}"
          fi
          
          BRANCH="${GITHUB_REF##*/}"
          if [ "$BRANCH" != "main" ]; then
          VERSION="${VERSION}-${BRANCH}"
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$VERSION"
          git push origin "$VERSION"
          echo "TAG=$VERSION" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: ${VERSION}" >> $GITHUB_STEP_SUMMARY

      - name: Get previous tag
        id: prevtag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${{ steps.tag.outputs.TAG }}$" | head -n1)
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: ${PREV_TAG}" >> $GITHUB_STEP_SUMMARY

      - name: Show recent commits and tags
        run: |
          echo "Tags (sorted by creation date):"
          git tag --sort=-creatordate
          echo ""
          echo "Last 20 commits (with tags and branches):"
          git log --oneline --decorate --graph -20

      - name: Debug Tags and Commits
        run: |
          git tag --sort=-creatordate
          git log --oneline --decorate --graph -20

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.TAG }}
          generate_release_notes: true

      - name: Get GitHub Release Notes
        id: get_release_notes
        run: |
          NOTES=$(gh api /repos/${{ github.repository }}/releases/tags/${{ steps.tag.outputs.TAG }} --jq '.body')
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_STEP_SUMMARY
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-matrix:
    if: ${{ github.event.inputs.only_description != 'true' }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      - name: Build loader/version matrix
        id: set-matrix
        run: |
          export MIN_VERSION=$(grep '^buildFromVersion=' gradle.properties | cut -d'=' -f2)
          MATRIX=$(python3 <<'PY'
          import json, os, pathlib, urllib.request

          min_version = os.environ["MIN_VERSION"]
          version_filter = os.environ.get("VERSION_FILTER", "").strip()

          def parse_version(ver: str):
              parts = [int(part) for part in ver.split(".")]
              while len(parts) < 3:
                  parts.append(0)
              return parts

          def version_at_least(ver: str, minimum: str):
              return parse_version(ver) >= parse_version(minimum)

          data = json.loads(pathlib.Path("versions.matrix.json").read_text())
          matrix = []

          fabric_versions = []
          if data.get("fabric"):
              for entry in data["fabric"]:
                  if isinstance(entry, str) and version_at_least(entry, min_version):
                      fabric_versions.append(entry)
          else:
              with urllib.request.urlopen("https://meta.fabricmc.net/v2/versions/game") as resp:
                  versions = json.load(resp)
              stable = sorted({entry["version"] for entry in versions if entry.get("stable")}, key=parse_version)
              fabric_versions = [ver for ver in stable if version_at_least(ver, min_version)]

          for mc in fabric_versions:
              matrix.append({"loader": "fabric", "mcVersion": mc, "args": []})

          for entry in data.get("forge", []):
              if isinstance(entry, str):
                  mc = entry
                  props = {}
              else:
                  mc = entry.get("mc") or entry.get("mcVersion")
                  props = entry.get("properties") or {}
              if not mc or not version_at_least(mc, min_version):
                  continue
              args = [f"-P{key}={value}" for key, value in props.items()]
              matrix.append({"loader": "forge", "mcVersion": mc, "args": args})

          if version_filter:
              matrix = [entry for entry in matrix if entry["mcVersion"] == version_filter]
          print(json.dumps(matrix))
          PY
          )
          if [ -z "$MATRIX" ] || [ "$MATRIX" = "[]" ]; then
            echo "No matching Minecraft versions found."
            exit 1
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Resolved matrix: $MATRIX"
        env:
          VERSION_FILTER: ${{ github.event.inputs.version }}

  build:
    needs: [ generate-matrix, release ]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    name: Build ${{ matrix.loader }} ${{ matrix.mcVersion }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build loader artifact
        env:
          LOADER: ${{ matrix.loader }}
          MC_VERSION: ${{ matrix.mcVersion }}
          TAG: ${{ needs.release.outputs.TAG }}
          VERSION_TYPE: ${{ github.event.inputs.version_type }}
          DEBUG_FLAG: ${{ github.event.inputs.debug }}
          EXTRA_ARGS: ${{ join(matrix.args, ' ') }}
        run: |
          set -euo pipefail
          if [ "$LOADER" = "fabric" ]; then
              TASKS=":loader-fabric:build :loader-fabric:remapJar"
          else
              TASKS=":loader-${LOADER}:build"
          fi
          ./gradlew $TASKS -PmcVersion=$MC_VERSION -Ptag=$TAG -Pversion_type=$VERSION_TYPE -Pdebug=$DEBUG_FLAG $EXTRA_ARGS

      - name: Upload jars to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.TAG }}
          files: loader-${{ matrix.loader }}/build/libs/**/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Write release notes to file
        run: echo "${{ needs.release.outputs.notes }}" > release-notes.md

      - name: Publish to Modrinth
        if: matrix.loader == 'fabric'
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
          GITHUB_SHA: ${{ github.sha }}
          CHANGELOG: ${{ needs.release.outputs.notes }}
        run: |
          ./gradlew :loader-fabric:modrinth -PmcVersion=${{ matrix.mcVersion }} -Ptag=${{ needs.release.outputs.TAG }} -Pversion_type=${{ github.event.inputs.version_type }} -Pdebug=${{ github.event.inputs.debug }} ${{ join(matrix.args, ' ') }}

  update-description:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Update Description
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: ./gradlew modrinthSyncBody -Pdebug=${{ github.event.inputs.debug }}
